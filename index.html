<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF--ar" />
    <link rel="icon" href="https://picsum.photos/32" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#111827" />
    <title>PWA Push Notification Sender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="./public/manifest.json" />
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>
    <style>
      .tab-active {
        border-bottom: 2px solid #22d3ee;
        color: white;
      }
      .tab-inactive {
        color: #9ca3af;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white">
    <div
      class="min-h-screen bg-gray-900 text-gray-200 flex flex-col items-center p-4 sm:p-6 md:p-8 font-sans"
    >
      <div
        class="w-full max-w-2xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 md:p-8 space-y-6"
      >
        <header class="text-center">
          <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">
            PWA Push Notification Sender
          </h1>
          <p class="text-gray-400 mt-2">
            Get your FCM token and test push notifications.
          </p>
        </header>

        <div class="bg-gray-700 p-4 rounded-lg text-center">
          <h2 class="font-semibold text-lg mb-2 text-white">
            1. Notification Permission
          </h2>
          <div id="permission-loading">
            <p class="text-yellow-400">Checking permission...</p>
          </div>
          <div id="permission-granted" style="display: none">
            <p class="text-green-400">
              Permission Granted! You can receive notifications.
            </p>
          </div>
          <div id="permission-denied" style="display: none">
            <p class="text-red-400 mb-4">
              Permission Denied. Please enable notifications in your browser
              settings.
            </p>
            <button
              id="request-permission-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mx-auto transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                ></path>
              </svg>
              <span class="ml-2">Request Permission</span>
            </button>
          </div>
        </div>

        <div id="token-section" style="display: none" class="bg-gray-700 p-4 rounded-lg">
          <h2 class="font-semibold text-lg mb-3 text-center text-white">
            2. Your FCM Device Token
          </h2>
          <div class="relative bg-gray-900 p-3 rounded-md">
            <p id="token-display" class="text-cyan-300 break-all text-sm font-mono"></p>
            <button id="copy-token-btn" class="absolute top-2 right-2 p-2 text-gray-400 hover:text-white transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" ></path>
              </svg>
            </button>
            <span id="copy-token-feedback" class="absolute top-2 right-2 p-2 text-white text-xs" style="display: none;">Copied!</span>
          </div>
        </div>

        <div id="notification-customization-section" style="display: none" class="bg-gray-700 p-4 rounded-lg space-y-4">
          <h2 class="font-semibold text-lg mb-2 text-center text-white">
            3. Customize Notification
          </h2>
          <div>
            <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Notification Title</label>
            <input type="text" id="title-input" value="Hello from PWA!" class="w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" />
          </div>
          <div>
            <label for="body" class="block text-sm font-medium text-gray-300 mb-1">Notification Body</label>
            <input type="text" id="body-input" value="This is a test notification." class="w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" />
          </div>
        </div>
        
        <div id="test-section" style="display: none" class="space-y-6">
          <div class="bg-gray-700 p-4 rounded-lg space-y-4">
             <h2 class="font-semibold text-lg mb-2 text-center text-white">
              4. Send Test Notification
            </h2>
            <div class="bg-yellow-900/50 border border-yellow-700 text-yellow-300 p-3 rounded-lg text-sm">
              <p>
                <strong>Important:</strong> For security, push notifications must be sent from a secure server, not a browser. To test, paste your <strong>Firebase Server Key</strong> below, then copy the generated command and run it in your computer's terminal.
              </p>
            </div>
            <div>
              <label for="server-key-input" class="block text-sm font-medium text-gray-300 mb-1">Firebase Server Key</label>
              <input type="password" id="server-key-input" placeholder="Paste key to auto-fill the command below" class="w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" />
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-600">
                <button id="curl-tab-btn" class="px-4 py-2 text-sm sm:text-base tab-active">cURL (Linux/macOS)</button>
                <button id="powershell-tab-btn" class="px-4 py-2 text-sm sm:text-base tab-inactive">PowerShell (Windows)</button>
            </div>

            <!-- cURL Command -->
            <div id="curl-command-container">
                <div class="relative bg-gray-900 p-3 rounded-md rounded-tl-none">
                <h3 class="text-md font-semibold mb-2 text-gray-300">
                    Run this command in your Terminal:
                </h3>
                <code id="curl-command" class="text-cyan-300 break-all text-xs font-mono whitespace-pre-wrap"></code>
                <button id="copy-curl-btn" class="absolute top-2 right-2 p-2 text-gray-400 hover:text-white transition-colors" title="Copy command" >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" ></path>
                    </svg>
                </button>
                <span id="copy-curl-feedback" class="absolute top-2 right-2 p-2 text-white text-xs" style="display: none;">Copied!</span>
                </div>
            </div>

            <!-- PowerShell Command -->
            <div id="powershell-command-container" style="display: none;">
                <div class="relative bg-gray-900 p-3 rounded-md rounded-tl-none">
                <h3 class="text-md font-semibold mb-2 text-gray-300">
                    Run this command in PowerShell:
                </h3>
                <code id="powershell-command" class="text-cyan-300 break-all text-xs font-mono whitespace-pre-wrap"></code>
                <button id="copy-powershell-btn" class="absolute top-2 right-2 p-2 text-gray-400 hover:text-white transition-colors" title="Copy command" >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" ></path>
                    </svg>
                </button>
                <span id="copy-powershell-feedback" class="absolute top-2 right-2 p-2 text-white text-xs" style="display: none;">Copied!</span>
                </div>
            </div>
            
          </div>
        </div>

      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyBTITgeHnkkL6wJVMq4OE_LHJMDuA8_3ho",
          authDomain: "ssss-f0f3c.firebaseapp.com",
          projectId: "ssss-f0f3c",
          storageBucket: "ssss-f0f3c.firebasestorage.app",
          messagingSenderId: "216606777782",
          appId: "1:216606777782:web:d12657df0c63e46c53a117",
          measurementId: "G-PFF7HFMM7C",
        };

        const VAPID_KEY =
          "BO9A8Xc08GPOfQJOUSco5bLuPoG8WYrVxhy6MgpVUbqyFM57-mY_jFFoZytUxUM4WVeoqVrz-EQIyWSr_HAjKXE";

        // --- STATE & DOM ELEMENTS ---
        let fcmToken = null;
        let notificationTitle = "Hello from PWA!";
        let notificationBody = "This is a test notification.";

        const permissionLoadingEl = document.getElementById("permission-loading");
        const permissionGrantedEl = document.getElementById("permission-granted");
        const permissionDeniedEl = document.getElementById("permission-denied");
        const permissionDeniedText = permissionDeniedEl.querySelector("p");
        const requestPermissionBtn = document.getElementById("request-permission-btn");
        
        const tokenSectionEl = document.getElementById("token-section");
        const tokenDisplayEl = document.getElementById("token-display");
        const copyTokenBtn = document.getElementById("copy-token-btn");
        const copyTokenFeedback = document.getElementById("copy-token-feedback");

        const notificationCustomizationSectionEl = document.getElementById("notification-customization-section");
        const titleInput = document.getElementById("title-input");
        const bodyInput = document.getElementById("body-input");

        const testSectionEl = document.getElementById("test-section");
        const serverKeyInput = document.getElementById("server-key-input");
        
        // Command Tabs
        const curlTabBtn = document.getElementById('curl-tab-btn');
        const powershellTabBtn = document.getElementById('powershell-tab-btn');
        const curlContainer = document.getElementById('curl-command-container');
        const powershellContainer = document.getElementById('powershell-command-container');

        // cURL elements
        const curlCommandEl = document.getElementById("curl-command");
        const copyCurlBtn = document.getElementById("copy-curl-btn");
        const copyCurlFeedback = document.getElementById("copy-curl-feedback");
        
        // PowerShell elements
        const powerShellCommandEl = document.getElementById("powershell-command");
        const copyPowerShellBtn = document.getElementById("copy-powershell-btn");
        const copyPowerShellFeedback = document.getElementById("copy-powershell-feedback");

        // --- FIREBASE INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        // --- FUNCTIONS ---
        const showSections = () => {
            tokenSectionEl.style.display = "block";
            notificationCustomizationSectionEl.style.display = "block";
            testSectionEl.style.display = "block";
        }

        const hideSections = () => {
            tokenSectionEl.style.display = "none";
            notificationCustomizationSectionEl.style.display = "none";
            testSectionEl.style.display = "none";
        }

        const showPermissionState = (state, message = "") => {
          permissionLoadingEl.style.display = "none";
          permissionGrantedEl.style.display = state === "granted" ? "block" : "none";
          permissionDeniedEl.style.display =
            state === "denied" || state === "default" ? "block" : "none";
          hideSections();

          if ((state === "denied" || state === "default") && message) {
            permissionDeniedText.textContent = message;
          } else if (state === "denied" || state === "default") {
            permissionDeniedText.textContent =
              "Permission Denied. Please enable notifications in your browser settings.";
          }
        };

        const updateCurlCommand = () => {
          if (!fcmToken) return;
          const serverKey = serverKeyInput.value || "YOUR_SERVER_KEY_FROM_FIREBASE_CONSOLE";
          const command = `curl -X POST -H "Authorization: key=${serverKey}" -H "Content-Type: application/json" -d '{
  "to": "${fcmToken}",
  "notification": {
    "title": "${notificationTitle}",
    "body": "${notificationBody}"
  }
}' "https://fcm.googleapis.com/fcm/send"`;
          curlCommandEl.textContent = command;
        };

        const updatePowerShellCommand = () => {
            if (!fcmToken) return;
            const serverKey = serverKeyInput.value || "YOUR_SERVER_KEY_FROM_FIREBASE_CONSOLE";
            const payload = {
                to: fcmToken,
                notification: {
                    title: notificationTitle,
                    body: notificationBody,
                },
            };
            // Use single quotes around the -Body JSON to prevent issues with double quotes inside
            const jsonBody = JSON.stringify(payload, null, 2);
            const command = `Invoke-WebRequest -Uri "https://fcm.googleapis.com/fcm/send" \`
  -Method POST \`
  -Headers @{
    "Authorization" = "key=${serverKey}"
    "Content-Type"  = "application/json"
  } \`
  -Body '${jsonBody}'`;
            powerShellCommandEl.textContent = command;
        };
        
        const updateAllCommands = () => {
            updateCurlCommand();
            updatePowerShellCommand();
        }

        const getFCMToken = async () => {
          try {
            if (VAPID_KEY.includes("YOUR_VAPID_KEY")) {
              throw new Error(
                "VAPID_KEY is not set. Please update it in the script."
              );
            }

            const permission = await Notification.requestPermission();

            if (permission === "granted") {
              console.log("Notification permission granted.");
              showPermissionState("granted");

              const registration = await navigator.serviceWorker.register(
                "./public/firebase-messaging-sw.js"
              );
              console.log("Service Worker registered successfully.");

              const token = await messaging.getToken({
                vapidKey: VAPID_KEY,
                serviceWorkerRegistration: registration,
              });

              if (token) {
                fcmToken = token;
                tokenDisplayEl.textContent = token;
                showSections();
                updateAllCommands();
                console.log("FCM Token retrieved:", token);
              } else {
                throw new Error(
                  "Failed to get FCM token. This can happen if the VAPID key is incorrect or the service worker path is wrong."
                );
              }
            } else {
              console.log("Unable to get permission to notify.");
              showPermissionState("denied");
            }
          } catch (error) {
            console.error("An error occurred while retrieving token: ", error);
            showPermissionState("denied", `Error: ${error.message}`);
          }
        };

        // --- EVENT LISTENERS ---
        requestPermissionBtn.addEventListener("click", getFCMToken);
        serverKeyInput.addEventListener("input", updateAllCommands);

        copyTokenBtn.addEventListener("click", () => {
          if (fcmToken) {
            navigator.clipboard.writeText(fcmToken);
            copyTokenBtn.style.display = "none";
            copyTokenFeedback.style.display = "inline";
            setTimeout(() => {
              copyTokenBtn.style.display = "inline";
              copyTokenFeedback.style.display = "none";
            }, 2000);
          }
        });

        titleInput.addEventListener("input", (e) => {
          notificationTitle = e.target.value;
          updateAllCommands();
        });

        bodyInput.addEventListener("input", (e) => {
          notificationBody = e.target.value;
          updateAllCommands();
        });

        copyCurlBtn.addEventListener("click", () => {
          if (curlCommandEl.textContent) {
            navigator.clipboard.writeText(curlCommandEl.textContent);
            copyCurlBtn.style.display = "none";
            copyCurlFeedback.style.display = "inline";
            setTimeout(() => {
              copyCurlBtn.style.display = "inline";
              copyCurlFeedback.style.display = "none";
            }, 2000);
          }
        });

        copyPowerShellBtn.addEventListener("click", () => {
          if (powerShellCommandEl.textContent) {
            navigator.clipboard.writeText(powerShellCommandEl.textContent);
            copyPowerShellBtn.style.display = "none";
            copyPowerShellFeedback.style.display = "inline";
            setTimeout(() => {
              copyPowerShellBtn.style.display = "inline";
              copyPowerShellFeedback.style.display = "none";
            }, 2000);
          }
        });

        // Tab switching logic
        curlTabBtn.addEventListener('click', () => {
            curlContainer.style.display = 'block';
            powershellContainer.style.display = 'none';
            curlTabBtn.classList.add('tab-active');
            curlTabBtn.classList.remove('tab-inactive');
            powershellTabBtn.classList.add('tab-inactive');
            powershellTabBtn.classList.remove('tab-active');
        });

        powershellTabBtn.addEventListener('click', () => {
            curlContainer.style.display = 'none';
            powershellContainer.style.display = 'block';
            powershellTabBtn.classList.add('tab-active');
            powershellTabBtn.classList.remove('tab-inactive');
            curlTabBtn.classList.add('tab-inactive');
            curlTabBtn.classList.remove('tab-active');
        });

        // Listen for foreground messages
        messaging.onMessage((payload) => {
          console.log("Message received. ", payload);
          // Show a more elegant custom notification instead of a jarring alert
          const notificationContainer = document.createElement('div');
          notificationContainer.className = "fixed top-5 right-5 bg-gray-700 text-white p-4 rounded-lg shadow-lg border border-cyan-500 z-50";
          notificationContainer.innerHTML = `
            <h4 class="font-bold">${payload.notification.title}</h4>
            <p>${payload.notification.body}</p>
          `;
          document.body.appendChild(notificationContainer);
          setTimeout(() => {
            notificationContainer.remove();
          }, 5000); // Remove after 5 seconds
        });

        // --- INITIALIZATION ON LOAD ---
        if (Notification.permission === "granted") {
          getFCMToken();
        } else {
          showPermissionState(Notification.permission);
        }
      });
    </script>
  </body>
</html>